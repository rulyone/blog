<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Write Blog Post - Quantum Entangled</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link rel="stylesheet" th:href="@{/css/animations.css}" />
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
</head>

<body>

    <header class="sticky-header shadow-inset-center">
        <h1 class="flip-2-ver-left-fwd">üìù Quantum Entangled</h1>
    </header>
    <main>

    
    <form hx-post="/upload-image" hx-trigger="change" hx-target="#upload-result" enctype="multipart/form-data">
        <input type="file" name="image" accept="image/*" />
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    </form>

    <div id="upload-result"></div>
    <form hx-post="/posts" hx-target="#message" hx-swap="innerHTML">
        <input type="text" name="title" placeholder="Title" required><br><br>

        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <textarea name="content" id="editor" rows="10" cols="80" placeholder="Write in Markdown..."
            hx-post="/posts/preview" hx-trigger="keyup changed delay:500ms" hx-target="#preview"
            hx-swap="innerHTML"></textarea><br><br>

        <button type="submit">Save Post</button>
    </form>

    <div id="message"></div>

    <hr>
    <h2>Live Preview</h2>
    <div id="preview" style="border:1px solid #ccc; padding:10px;"></div>



    <form action="/logout" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit">Logout</button>
    </form>
</main>

    <script>
        document.body.addEventListener("htmx:afterRequest", function (event) {
            console.info(event.detail.target.id);
            if (event.detail.target.id === "upload-result") {  // Ensure event from the file input

                const url = event.detail.xhr.responseText;
                const textarea = document.querySelector("textarea[name='content']");
                if (!textarea) return;

                // Insert markdown image syntax at cursor position
                const cursorPos = textarea.selectionStart;
                const textBefore = textarea.value.substring(0, cursorPos);
                const textAfter = textarea.value.substring(cursorPos);
                textarea.value = `${textBefore}<img class="resp-images" src="${url}" width="" height="">${textAfter}`;

                // Optionally, put cursor after inserted image markdown
                const newCursorPos = cursorPos + `<img class="resp-images" src="${url}" width="" height="">`.length;
                textarea.setSelectionRange(newCursorPos, newCursorPos);
                textarea.focus();
            }
        });
    </script>

</body>

</html>